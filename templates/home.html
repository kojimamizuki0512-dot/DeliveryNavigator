{% extends "base.html" %}
{% load static %}

{% block title %}Delivery Navigator — リアルタイム地図＆今日のAIルート{% endblock %}

{% block header %}
  <!-- Leaflet（地図） & Heatmap プラグイン -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <style>
    .page-h1{font-weight:800;font-size:clamp(22px,3.2vw,36px);margin:14px 0 18px}
    .map-card,.route-card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:0;overflow:hidden}
    .map-toolbar{
      position:absolute;top:10px;left:10px;z-index:5000;
      background:rgba(8,14,28,0.86);backdrop-filter:blur(6px);
      border:1px solid var(--line);border-radius:12px;padding:10px;min-width:260px
    }
    .map-toolbar .row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .map-toolbar label{font-size:12px;color:#b7c6de;min-width:62px}
    .map-footer{
      position:absolute;bottom:10px;left:10px;z-index:5000;
      background:rgba(8,14,28,0.82);border:1px solid var(--line);border-radius:12px;padding:8px 10px;color:var(--muted);font-size:12px
    }
    .legend{display:flex;align-items:center;gap:8px}
    .legend-bar{width:120px;height:10px;border-radius:8px;background:linear-gradient(90deg,#1f3d73,#3f86ff,#4cc9f0,#b6f09c)}
    #map{width:100%;height:72vh;min-height:420px}
    .route-card .head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
    .route-card .body{padding:14px 16px}
    .pill{border:1px solid var(--line);border-radius:999px;padding:2px 8px;color:var(--muted);font-size:12px}
    .block{border:1px solid var(--line);border-radius:12px;padding:10px 12px;margin-bottom:10px;background:#0f1e3d}
    .block h4{margin:0 0 4px;font-size:14px}
    .rank-item{display:flex;justify-content:space-between;border-bottom:1px solid var(--line);padding:8px 2px}
    .rank-item:last-child{border-bottom:none}
    .muted-sm{color:var(--muted);font-size:12px}
    .btn.full{width:100%}
    .grid-2{display:grid;grid-template-columns:2fr 1.2fr;gap:16px}
    @media (max-width:980px){.grid-2{grid-template-columns:1fr}}
  </style>
{% endblock %}

{% block content %}
  <h1 class="page-h1">リアルタイムで“いま稼げる地域”を地図でチェック</h1>

  <div class="grid-2">
    <!-- 左：地図 -->
    <section class="map-card">
      <div style="position:relative">
        <div id="map"></div>

        <!-- コントロール -->
        <div class="map-toolbar">
          <div class="row">
            <label>開始</label>
            <input id="startTime" type="time">
          </div>
          <div class="row">
            <label>稼働</label>
            <select id="horizon">
              <option value="3">3時間</option>
              <option value="4" selected>4時間</option>
              <option value="5">5時間</option>
              <option value="6">6時間</option>
            </select>
          </div>
          <div class="row">
            <label>移動コスト</label>
            <select id="mobility">
              <option value="low">低</option>
              <option value="mid" selected>中</option>
              <option value="high">高</option>
            </select>
          </div>
          <div class="row">
            <label>AIモード</label>
            <select id="mode">
              <option value="blend" selected>ブレンド</option>
              <option value="base">ベース統計</option>
              <option value="ml">MLのみ</option>
            </select>
          </div>
          <button id="btnPlan" class="btn full">今日のAIルート</button>
          <div class="muted-sm" style="margin-top:6px">ヒートは2分ごとに自動更新 /api/areas/stats</div>
        </div>

        <!-- フッター（凡例） -->
        <div class="map-footer">
          <div class="legend">
            <span class="muted-sm">期待時給</span>
            <div class="legend-bar"></div>
            <span class="muted-sm">高</span>
          </div>
        </div>
      </div>
    </section>

    <!-- 右：AIルート & ランキング -->
    <section class="route-card">
      <div class="head">
        <h3 style="margin:0">今日のAIルート</h3>
        <span id="planBadge" class="pill">未生成</span>
      </div>
      <div class="body">
        <div id="planBlocks" style="margin-bottom:14px"></div>

        <h3 style="margin:8px 0 6px">ランキング（トップ20）</h3>
        <div id="ranking"></div>
      </div>
    </section>
  </div>

  <script>
    // ----------- 設定 -----------
    const MOBILITY_BETA = { low: 60, mid: 120, high: 240 }; // 移動ペナルティ（円/km）
    const AUTO_REFRESH_MS = 120000; // 2分

    // ----------- UI要素 -----------
    const $start  = document.getElementById('startTime');
    const $hor    = document.getElementById('horizon');
    const $mob    = document.getElementById('mobility');
    const $mode   = document.getElementById('mode');
    const $btn    = document.getElementById('btnPlan');
    const $plan   = document.getElementById('planBlocks');
    const $badge  = document.getElementById('planBadge');
    const $rank   = document.getElementById('ranking');

    // ----------- 時刻初期値（次の15分丸め） -----------
    (function initStartTime(){
      const now = new Date();
      let m = Math.ceil((now.getMinutes()+1)/15)*15;
      let h = now.getHours();
      if (m===60){ h=(h+1)%24; m=0; }
      $start.value = String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0');
    })();

    // ----------- 地図初期化 -----------
    const map = L.map('map',{ zoomControl:true, scrollWheelZoom:true });
    // 初期中心：東京駅付近（データがあれば後でfitBounds）
    map.setView([35.6812,139.7671], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let heatLayer = null;
    let routeLayer = L.layerGroup().addTo(map);
    let areaPoints = {}; // slug -> {lat,lng,name}

    // ----------- エリアリスト取得（初回だけ） -----------
    async function loadAreas(){
      const res = await fetch('/api/areas/list/');
      const js  = await res.json();
      const pts = js.areas || [];
      let bounds = [];
      pts.forEach(a=>{
        areaPoints[a.slug] = {lat:a.lat, lng:a.lng, name:a.name};
        bounds.push([a.lat,a.lng]);
      });
      if (bounds.length){
        const b = L.latLngBounds(bounds);
        map.fitBounds(b.pad(0.15));
      }
    }

    // ----------- ヒートマップ更新 -----------
    async function refreshHeat(){
      const now = new Date();
      const dow = (now.getDay()+6)%7; // JS:0=Sun -> 0=Monへ合わせる
      const hour= now.getHours();
      const mode = $mode.value;

      const res  = await fetch(`/api/areas/stats/?dow=${dow}&hour=${hour}&mode=${mode}`);
      const js   = await res.json();
      const rows = js.ranking || [];
      $rank.innerHTML = renderRanking(rows);

      // intensity を 0..1 に正規化
      const vmax = Math.max(1, ...rows.map(r => r.hourly || 0));
      const heat = rows.map(r => [r.lat, r.lng, Math.max(0.05, (r.hourly||0)/vmax)]);

      if (heatLayer){ map.removeLayer(heatLayer); }
      heatLayer = L.heatLayer(heat, { radius: 28, blur: 18, maxZoom: 14 }).addTo(map);
    }

    function renderRanking(rows){
      const top = rows.slice(0,20);
      if (!top.length) return '<div class="muted-sm">データがありません。</div>';
      return top.map((r,i)=>`
        <div class="rank-item">
          <div><span class="pill" style="margin-right:8px">#${i+1}</span>${r.name}</div>
          <div class="muted-sm">${r.hourly} 円/h <span style="margin-left:8px">(${r.samples_h}h)</span></div>
        </div>
      `).join('');
    }

    // ----------- ルート生成 & 地図に描画 -----------
    async function makePlan(){
      routeLayer.clearLayers();

      const start = $start.value;
      const hours = $hor.value;
      const mode  = $mode.value;
      const beta  = MOBILITY_BETA[$mob.value] || 120;

      const url = `/api/areas/today_plan/?start=${encodeURIComponent(start)}&hours=${hours}&beta=${beta}&mode=${mode}`;
      const res = await fetch(url);
      const js  = await res.json();
      const blocks = js.blocks || [];

      if (!blocks.length){
        $badge.textContent = '未生成';
        $plan.innerHTML = '<div class="muted-sm">データ不足のため提案できません。</div>';
        return;
      }

      $badge.textContent = `${blocks.length}ブロック`;

      // リスト表示
      $plan.innerHTML = blocks.map(b => `
        <div class="block">
          <h4>${b.time} — ${b.name}</h4>
          <div class="muted-sm">期待: ${b.expected_hourly} 円/h　サンプル: ${b.samples_h} h</div>
        </div>
      `).join('');

      // 地図に線とピン
      const pts = [];
      blocks.forEach(b=>{
        pts.push([b.lat,b.lng]);
        const mk = L.circleMarker([b.lat,b.lng],{
          radius:8, weight:1, color:'#4cc9f0', fillOpacity:0.8
        }).bindTooltip(`${b.time}<br>${b.name}<br>${b.expected_hourly} 円/h`, {sticky:true});
        routeLayer.addLayer(mk);
      });
      if (pts.length>=2){
        const pl = L.polyline(pts,{weight:3,opacity:0.8});
        routeLayer.addLayer(pl);
        map.fitBounds(pl.getBounds().pad(0.2));
      }else if (pts.length===1){
        map.setView(pts[0], 13);
      }
    }

    // ----------- 初期化とオートリフレッシュ -----------
    (async function boot(){
      await loadAreas();
      await refreshHeat();
      setInterval(refreshHeat, AUTO_REFRESH_MS);
    })();

    $btn.addEventListener('click', makePlan);
    $mode.addEventListener('change', refreshHeat);
  </script>
{% endblock %}
