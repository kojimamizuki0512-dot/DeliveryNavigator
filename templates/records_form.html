{% extends 'base.html' %}
{% block title %}マップ | Delivery Navigator{% endblock %}


{% block content %}
<section class="section-head">
<h2>ヒートマップ</h2>
<p class="muted">強度は色と模様で表現。エリアをタップして詳細カードを表示。</p>
</section>


<div class="legend" aria-label="ヒート凡例">
<span class="legend-item legend-low">低</span>
<span class="legend-item legend-mid">中</span>
<span class="legend-item legend-high">高</span>
</div>


<div id="mapRoot" class="map-root" data-endpoint="/api/areas/stats?mode=base"></div>
<div id="mapPanel" class="map-panel hidden" aria-live="polite"></div>
{% endblock %}


{% block extra_js %}
<script>
// シンプルグリッド擬似マップ（将来Leaflet/MapLibre置換可）
(async function(){
const root = document.getElementById('mapRoot');
const panel = document.getElementById('mapPanel');
if (!root) return;
try {
const r = await fetch(root.dataset.endpoint, { credentials: 'same-origin' });
const data = await r.json();
const items = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);


// 6x8のタイルに投影（ダミー）: intensity=low/mid/high を想定
const cols = 6, rows = 8; let html = '';
for (let i=0;i<rows*cols;i++) {
const it = items[i % Math.max(1, items.length)] || {};
const lv = it.level || (i%3===0?'high':i%3===1?'mid':'low');
html += `<button class="tile tile--${lv}" aria-label="${it.area||'エリア'}: ${lv}" data-area="${it.area||''}" data-wage="${it.wage_per_h||''}"></button>`;
}
root.innerHTML = html;


root.addEventListener('click', (e)=>{
const t = e.target.closest('.tile');
if (!t) return;
const area = t.dataset.area || 'サンプルエリア';
const wage = t.dataset.wage ? '¥'+t.dataset.wage : '—';
panel.innerHTML = `
<article class="card">
<div class="card-head"><span class="badge">Now</span><h3>${area}</h3></div>
<div class="card-metrics">
<div><span class="k">${wage}</span><span class="l">/h</span></div>
<div><span class="k">低</span><span class="l">ロング率</span></div>
<div><span class="k">+5%</span><span class="l">前週比</span></div>
</div>
<a class="btn btn-primary btn-sm" href="/">このエリアで開始</a>
</article>`;
panel.classList.remove('hidden');
});
} catch(e){ console.warn(e); }
})();
</script>
{% endblock %}