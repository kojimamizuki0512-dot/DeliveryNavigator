{% extends 'base.html' %}
{% block title %}ホーム | Delivery Navigator{% endblock %}

{% block extra_head %}
  <!-- 地図（CDN）※API不要。タイルは一般公開の標準タイルを使用 -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <style>
    .quick-links { display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 16px; }
    .quick-links a{ display:inline-flex; align-items:center; gap:6px; padding:8px 12px; border:1px solid var(--border);
      border-radius:999px; text-decoration:none; color:var(--text); background:var(--surface); }
    .home-grid{ display:grid; gap:16px; grid-template-columns:1fr; align-items:start; }
    @media (min-width:980px){ .home-grid{ grid-template-columns:1.2fr 0.8fr; } }
    .panel{ background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:16px; }
    .panel h2{ margin:0 0 8px; font-size:var(--fs-800); }

    /* 左：地図 */
    #leafletMap{ width:100%; height:560px; border-radius:var(--radius); }
    .map-toolbar{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
    .legend{ display:inline-flex; gap:8px; align-items:center; margin:8px 0 12px; }
    .legend-item{ border-radius:999px; padding:6px 12px; font-size:12px; border:1px solid var(--border); }
    .legend-low{  background:repeating-linear-gradient(45deg,#e5e7eb,#e5e7eb 6px,#f8fafc 6px,#f8fafc 12px); color:#374151; }
    .legend-mid{  background:repeating-linear-gradient(45deg,#f6e9d4,#f6e9d4 6px,#fff3e0 6px,#fff3e0 12px); color:#8a5a18; }
    .legend-high{ background:repeating-linear-gradient(45deg,#d8f3dc,#d8f3dc 6px,#c7f6e2 6px,#c7f6e2 12px); color:#065f46; }

    /* 右：ルート */
    .route-head{ display:flex; gap:8px; align-items:center; justify-content:space-between; }
    .route-list{ list-style:none; padding:0; margin:8px 0 0; display:grid; gap:10px; }
    .route-item{ border:1px dashed var(--border); border-radius:12px; padding:10px 12px;
      display:grid; grid-template-columns:92px 1fr max-content; gap:8px; align-items:center;
      transition:background .15s ease, border-color .15s ease; }
    .route-item.active{ border-color:var(--brand-2); background:color-mix(in oklab, var(--surface) 85%, var(--brand-2)); }
    .route-time{ font-weight:700; }
    .route-area{ font-size:14px; }
    .route-wage{ font-weight:700; }
    .sub{ font-size:12px; color:var(--muted); }
    .muted{ color:var(--muted); }
    .divider{ height:1px; background:var(--border); margin:10px 0; }
    .btn-ghost-plain{ border-color:transparent; }
    .select{ border:1px solid var(--border); border-radius:10px; background:var(--surface); padding:8px 10px; }
  </style>
{% endblock %}

{% block content %}
<nav class="quick-links" aria-label="ショートカット">
  <a href="{% url 'map' %}">マップ</a>
  <a href="{% url 'upload' %}">データ読み込み</a>
  <a href="{% url 'records' %}">記録</a>
  <a href="{% url 'dashboard' %}">ダッシュボード</a>
</nav>

<section class="home-grid">
  <!-- 左：ヒート（本物の地図＋点） -->
  <div class="panel">
    <h2>いま稼げるエリア</h2>
    <div class="map-toolbar">
      <div>
        <label class="sub">ジャンプ：</label>
        <select id="jumpSelect" class="select"></select>
        <button id="btnJump" class="btn btn-outline btn-sm">移動</button>
      </div>
      <div style="margin-left:auto; display:flex; gap:8px;">
        <button id="btnReload" class="btn btn-outline btn-sm">更新</button>
        <button id="btnLocate" class="btn btn-outline btn-sm">現在地</button>
      </div>
    </div>
    <div class="legend" aria-label="凡例">
      <span class="legend-item legend-low">低</span>
      <span class="legend-item legend-mid">中</span>
      <span class="legend-item legend-high">高</span>
    </div>
    <div id="leafletMap"></div>
    <div id="mapInfo" class="sub" style="margin-top:8px;"></div>
  </div>

  <!-- 右：おすすめルート（30分刻み） -->
  <div class="panel">
    <div class="route-head">
      <h2>今日のおすすめルート</h2>
      <div style="display:flex; gap:8px;">
        <button id="btnGPX" class="btn btn-outline btn-sm">GPX保存</button>
        <button id="btnCopy" class="btn btn-outline btn-sm">一覧コピー</button>
      </div>
    </div>
    <p class="muted">はじめの2〜3時間の目安。状況で変わるので、時々更新してください。</p>
    <ul id="routeList" class="route-list"><li class="sub">読み込み中…</li></ul>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
  // —— 共有：区名→おおよその位置（座標が無い時の予備）——
  const WARD_POS = DN_DATA.ward_pos || {};

  // —— 見た目の色 —— 
  const routeColor = () => getComputedStyle(document.documentElement).getPropertyValue('--brand-2').trim() || '#00754A';
  const levelColor = (w)=> (w>=1800 ? '#18a058' : (w>=1600 ? '#c4852e' : '#9ca3af'));

  // —— 地図の用意 —— 
  let map, heatMarkers=[], routeLine=null, routeStops=[];
  (function initMap(){
    const el = document.getElementById('leafletMap');
    if (!el) return;
    const centerTokyo = [35.681236,139.767125];
    map = L.map(el, { zoomControl:true }).setView(centerTokyo, 12);

    const light = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{ attribution:'&copy; OpenStreetMap & Carto', maxZoom:19 });
    const dark  = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{  attribution:'&copy; OpenStreetMap & Carto', maxZoom:19 });

    function applyBase() {
      const isDark = document.documentElement.getAttribute('data-theme') === 'espresso';
      if (map.hasLayer(light)) map.removeLayer(light);
      if (map.hasLayer(dark))  map.removeLayer(dark);
      (isDark ? dark : light).addTo(map);
      if (routeLine) routeLine.setStyle({ color: routeColor() });
      routeStops.forEach(m => m.setStyle && m.setStyle({ color: routeColor(), fillColor: routeColor() }));
    }
    applyBase();
    new MutationObserver(applyBase).observe(document.documentElement,{ attributes:true, attributeFilter:['data-theme'] });

    drawHeat(DN_DATA.areas || []);
    fitToHeat();

    // ジャンプ選択
    const sel = document.getElementById('jumpSelect');
    const wards = Object.keys(WARD_POS);
    wards.forEach(w => { const o=document.createElement('option'); o.value=w; o.textContent=w; sel.appendChild(o); });
    document.getElementById('btnJump').addEventListener('click', ()=>{
      const w = sel.value; const pos = WARD_POS[w]; if (!pos) return;
      map.setView(pos, 13, { animate:true });
    });

    // 現在地へ
    document.getElementById('btnLocate').addEventListener('click', ()=>{
      if (!navigator.geolocation) return alert('位置情報が使えません');
      navigator.geolocation.getCurrentPosition((pos)=>{
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        map.setView([lat,lng], 15, { animate:true });
        L.circleMarker([lat,lng], { radius:8, color:'#2563EB', fillColor:'#2563EB', fillOpacity:0.9, weight:2 }).addTo(map).bindPopup('現在地');
      }, ()=> alert('現在地を取得できませんでした'));
    });

    // 更新（ダミーの変動）
    document.getElementById('btnReload').addEventListener('click', ()=>{
      const next = (DN_DATA.areas || []).map(a => ({ ...a, wage_per_h: Math.round((a.wage_per_h||1500) * (0.95 + Math.random()*0.1)) }));
      drawHeat(next, true);
      fitToHeat();
    });
  })();

  function drawHeat(items, clear=false){
    if (!map) return;
    if (clear || heatMarkers.length){ heatMarkers.forEach(m=>map.removeLayer(m)); heatMarkers=[]; }
    const info = document.getElementById('mapInfo');
    const markers=[];
    items.forEach(it=>{
      const name = it.area || it.name || 'エリア';
      const wage = Number(it.wage_per_h || it.score || 0);
      const center = Array.isArray(it.center)&&it.center.length===2 ? it.center : (WARD_POS[name]||null);
      if (!center) return;
      const color = levelColor(wage);
      const m=L.circleMarker(center,{ radius:10,color,fillColor:color,fillOpacity:.6,weight:2 }).addTo(map);
      m.bindPopup(`<strong>${name}</strong><br>${wage?`目安：¥${wage}/h`:'目安：—'}${it.note?`<br><span class="sub">${it.note}</span>`:''}`);
      markers.push(m);
    });
    heatMarkers=markers;
    info.textContent = `表示件数：${markers.length}`;
  }

  function fitToHeat(){
    if (!heatMarkers.length) return;
    const group=L.featureGroup(heatMarkers);
    map.fitBounds(group.getBounds().pad(0.2));
  }

  // —— 右：ルート（30分刻み） —— 
  (function loadRoute(){
    const list=document.getElementById('routeList');
    if(!list) return;

    const items = Array.isArray(DN_DATA.plan)? DN_DATA.plan : [];
    list.innerHTML = items.map((it,i)=>`
      <li class="route-item" data-idx="${i}">
        <div class="route-time">${it.time}</div>
        <div class="route-area">
          <strong>${it.area||'—'}</strong>${it.to?` <span class="muted">→ ${it.to}</span>`:''}
          ${it.note?`<div class="sub">${it.note}</div>`:''}
        </div>
        <div class="route-wage">${it.wage_per_h?('¥'+it.wage_per_h):'—'}/h</div>
      </li>`).join('');

    // 線描画
    const coords = items.map(it=>{
      if (Array.isArray(it.center)&&it.center.length===2) return it.center;
      if (it.lat!=null && it.lng!=null) return [Number(it.lat),Number(it.lng)];
      const name=it.area||it.name||''; return WARD_POS[name]||null;
    }).filter(Boolean);

    if (routeLine){ map.removeLayer(routeLine); routeLine=null; }
    routeStops.forEach(m=>map.removeLayer(m)); routeStops=[];

    if (coords.length>=2){
      routeLine=L.polyline(coords,{ color:routeColor(), weight:5, opacity:.9 }).addTo(map);
      coords.forEach((pt,i)=>{
        const m=L.circleMarker(pt,{ radius:7, color:routeColor(), fillColor:routeColor(), fillOpacity:.9, weight:2 })
          .addTo(map)
          .bindPopup(`<div><strong>${items[i].time}</strong>　${items[i].area||'—'}${items[i].to?` → ${items[i].to}`:''}<br>${items[i].wage_per_h?`目安：¥${items[i].wage_per_h}/h`:'目安：—'}</div>`);
        routeStops.push(m);
      });
      map.fitBounds(routeLine.getBounds().pad(0.25));
    }

    // クリックで寄る
    list.addEventListener('click',(e)=>{
      const li=e.target.closest('.route-item'); if(!li) return;
      const i=Number(li.dataset.idx); const pt=coords[i]; if(!pt) return;
      list.querySelectorAll('.route-item').forEach(x=>x.classList.remove('active'));
      li.classList.add('active');
      map.setView(pt, Math.max(map.getZoom(), 13), { animate:true });
      if (routeStops[i]) routeStops[i].openPopup();
    });

    // GPX保存
    document.getElementById('btnGPX').addEventListener('click', ()=>{
      if (!coords.length) return alert('ルートがありません');
      const gpxHead = `<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1" creator="DN" xmlns="http://www.topografix.com/GPX/1/1"><trk><name>DN Route</name><trkseg>`;
      const gpxBody = coords.map(c=>`<trkpt lat="${c[0]}" lon="${c[1]}"></trkpt>`).join('');
      const gpxFoot = `</trkseg></trk><metadata></metadata></gpx>`;
      const blob = new Blob([gpxHead+gpxBody+gpxFoot], {type:'application/gpx+xml'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'dn_route.gpx';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // 一覧コピー
    document.getElementById('btnCopy').addEventListener('click', ()=>{
      const text = items.map(it =>
        `${it.time}  ${it.area||'—'}${it.to?` → ${it.to}`:''}  ${it.wage_per_h?('¥'+it.wage_per_h+'/h'):''}  ${it.note||''}`
      ).join('\n');
      navigator.clipboard.writeText(text).then(()=> alert('コピーしました'));
    });
  })();
</script>
{% endblock %}
