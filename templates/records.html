{% extends "base.html" %}
{% block title %}実績一覧 | Delivery Navigator{% endblock %}
{% block content %}
<h1 style="margin:0 0 8px 0;">実績一覧</h1>
<p class="muted">期間で絞り込み、各行の編集/削除、新規追加ができます。</p>

<form id="filter" style="display:flex;gap:8px;align-items:end;flex-wrap:wrap;margin:12px 0;">
  <div>
    <label>開始日</label><br>
    <input type="date" name="start">
  </div>
  <div>
    <label>終了日</label><br>
    <input type="date" name="end">
  </div>
  <button type="submit" class="btn">この期間で表示</button>
  <a class="btn" href="/api/deliveries/export/">CSVエクスポート</a>
</form>

<table id="tbl">
  <thead>
    <tr>
      <th>日付</th>
      <th>件数</th>
      <th>売上(円)</th>
      <th>稼働時間(h)</th>
      <th>時給(円)</th>
      <th></th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h2 style="margin:24px 0 8px 0;">新規追加</h2>
<form id="create" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px;max-width:720px;">
  {% csrf_token %}
  <div><label>日付</label><br><input type="date" name="date" required></div>
  <div><label>件数</label><br><input type="number" name="orders_completed" min="0" value="0" required></div>
  <div><label>売上(円)</label><br><input type="number" name="earnings" step="0.01" min="0" value="0" required></div>
  <div><label>稼働時間(h)</label><br><input type="number" name="hours_worked" step="0.01" min="0"></div>
  <div style="align-self:end"><button class="btn" type="submit">追加</button></div>
</form>

<dialog id="dlg">
  <form method="dialog" id="edit">
    {% csrf_token %}
    <h3 style="margin:0 0 8px 0;">編集</h3>
    <input type="hidden" name="id">
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;min-width:480px;">
      <div><label>日付</label><br><input type="date" name="date" required></div>
      <div><label>件数</label><br><input type="number" name="orders_completed" min="0" required></div>
      <div><label>売上(円)</label><br><input type="number" name="earnings" step="0.01" min="0" required></div>
      <div><label>稼働時間(h)</label><br><input type="number" name="hours_worked" step="0.01" min="0"></div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn" value="cancel">キャンセル</button>
      <button class="btn" id="btn-save" value="default">保存</button>
    </div>
  </form>
</dialog>

<script>
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  function hourly(r){
    const h = parseFloat(r.hours_worked || 0);
    const e = parseFloat(r.earnings || 0);
    if(!h) return "";
    return Math.round(e / h);
  }
  function fmtDate(d){ return d; } // APIは YYYY-MM-DD なのでそのまま

  async function load() {
    const f = new FormData(document.getElementById('filter'));
    const q = [];
    if (f.get('start')) q.push('start='+encodeURIComponent(f.get('start')));
    if (f.get('end')) q.push('end='+encodeURIComponent(f.get('end')));
    const url = '/api/deliveries/' + (q.length ? ('?'+q.join('&')) : '');
    const res = await fetch(url, {headers:{'Accept':'application/json'}});
    const data = await res.json();
    const rows = Array.isArray(data) ? data : (data.results || []);
    const tbody = document.querySelector('#tbl tbody');
    tbody.innerHTML = '';
    rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${fmtDate(r.date)}</td>
        <td>${r.orders_completed}</td>
        <td>${r.earnings}</td>
        <td>${r.hours_worked ?? ''}</td>
        <td>${hourly(r)}</td>
        <td>
          <button class="btn btn-edit" data-id="${r.id}">編集</button>
          <button class="btn btn-del" data-id="${r.id}">削除</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  document.getElementById('filter').addEventListener('submit', (e)=>{
    e.preventDefault(); load();
  });

  // 新規追加
  document.getElementById('create').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(e.target);
    const body = {
      date: fd.get('date'),
      orders_completed: parseInt(fd.get('orders_completed')||'0'),
      earnings: fd.get('earnings'),
      hours_worked: fd.get('hours_worked') || null,
    };
    const res = await fetch('/api/deliveries/', {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'X-CSRFToken': getCookie('csrftoken') || ''
      },
      body: JSON.stringify(body)
    });
    if(!res.ok){ alert('作成に失敗しました'); return; }
    e.target.reset();
    load();
  });

  // 編集/削除ボタン（テーブルのイベント委譲）
  document.querySelector('#tbl').addEventListener('click', async (e)=>{
    const btn = e.target.closest('button');
    if(!btn) return;
    const id = btn.dataset.id;
    if(btn.classList.contains('btn-del')){
      if(!confirm('このレコードを削除しますか？')) return;
      const res = await fetch('/api/deliveries/'+id+'/', {
        method:'DELETE',
        headers:{ 'X-CSRFToken': getCookie('csrftoken') || '' }
      });
      if(!res.ok){ alert('削除に失敗しました'); return; }
      load();
      return;
    }
    if(btn.classList.contains('btn-edit')){
      // 1件取得
      const res = await fetch('/api/deliveries/'+id+'/', {headers:{'Accept':'application/json'}});
      const r = await res.json();
      const dlg = document.getElementById('dlg');
      const form = document.getElementById('edit');
      form.id.value = r.id;
      form.date.value = r.date;
      form.orders_completed.value = r.orders_completed;
      form.earnings.value = r.earnings;
      form.hours_worked.value = r.hours_worked ?? '';
      dlg.showModal();

      form.addEventListener('close', ()=>{}, {once:true});

      document.getElementById('btn-save').onclick = async (ev)=>{
        ev.preventDefault();
        const body = {
          date: form.date.value,
          orders_completed: parseInt(form.orders_completed.value||'0'),
          earnings: form.earnings.value,
          hours_worked: form.hours_worked.value || null,
        };
        const res2 = await fetch('/api/deliveries/'+form.id.value+'/', {
          method:'PUT',
          headers:{
            'Content-Type':'application/json',
            'X-CSRFToken': getCookie('csrftoken') || ''
          },
          body: JSON.stringify(body)
        });
        if(!res2.ok){ alert('更新に失敗しました'); return; }
        document.getElementById('dlg').close();
        load();
      };
    }
  });

  load(); // 初回ロード
</script>
{% endblock %}
