{% extends "base.html" %}
{% block title %}Delivery Navigator | ホーム{% endblock %}

{% block header %}
<section class="hero hero--fullscreen fullbleed">
  <div class="hero-art">
    <!-- シンプルなグラデーション背景（SVGでもOK） -->
    <div style="position:absolute;inset:0;background:radial-gradient(80% 60% at 50% 20%, rgba(76,201,240,0.18), transparent 60%), linear-gradient(180deg, rgba(12,20,38,0.2), rgba(12,20,38,0.6));"></div>
  </div>
  <div class="hero-overlay">
    <div class="wrap" style="padding:28px 16px;">
      <h1 style="font-size:clamp(28px,5vw,44px);margin:0 0 6px;">「いま」「きょう」の、最適スポットを。</h1>
      <p class="muted" style="margin:0;">配達直前にチェック → 今日のルートをAIが提案。待機中はリアルタイムランキングで微調整。</p>
    </div>
  </div>
</section>
{% endblock %}

{% block content %}
<div class="grid cols-2" style="margin-top:18px;">
  <!-- 左：リアルタイム（今の時刻の）エリア別ランキング -->
  <section class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <h2 style="margin:0;font-size:18px;">いまのおすすめ（エリア別）</h2>
      <span class="chip" id="rank-meta">--</span>
    </div>
    <div id="rank-list" class="grid" style="gap:8px;"></div>
    <div class="muted" style="margin-top:8px;font-size:12px;">※ サンプル時間が少ないエリアは精度が低くなります。</div>
  </section>

  <!-- 右：今日のAIルート -->
  <section class="card">
    <h2 style="margin:0 0 8px;font-size:18px;">今日のAIルート</h2>

    <div class="row" style="margin-bottom:10px;">
      <div style="flex:1;min-width:160px">
        <label>開始時刻</label>
        <input id="plan-start" type="time">
      </div>
      <div style="width:140px">
        <label>稼働時間</label>
        <select id="plan-hours">
          <option value="3">3時間</option>
          <option value="4" selected>4時間</option>
          <option value="5">5時間</option>
          <option value="6">6時間</option>
        </select>
      </div>
      <div style="width:160px">
        <label>移動ペナルティ (円/km)</label>
        <input id="plan-beta" type="number" step="10" min="0" value="120">
      </div>
      <div style="align-self:end">
        <button class="btn primary" id="btn-make-plan">ルートを作成</button>
      </div>
    </div>

    <div id="plan-list" class="grid" style="gap:8px;"></div>
  </section>
</div>

<script>
async function fetchJSON(url){
  const r = await fetch(url, {credentials: "same-origin"});
  if(!r.ok) throw new Error("HTTP "+r.status);
  return await r.json();
}

function nowHHMM() {
  const d = new Date();
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = d.getMinutes();
  const m = Math.ceil(mm/15)*15;
  const adj = (m===60)? "00" : String(m).padStart(2,'0');
  if(m===60 && hh!=="23"){ return String(Number(hh)+1).padStart(2,'0') + ":" + adj; }
  if(m===60 && hh==="23"){ return "23:45"; }
  return `${hh}:${adj}`;
}

// ランキング描画
function renderRanking(data){
  const meta = document.getElementById('rank-meta');
  meta.textContent = `曜:${data.dow} 時:${String(data.hour).padStart(2,'0')}:00`;
  const wrap = document.getElementById('rank-list'); wrap.innerHTML = "";
  data.ranking.slice(0,10).forEach((r, idx) => {
    const a = document.createElement('div');
    a.className = 'card'; a.style.padding = '10px';
    a.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="display:flex;gap:8px;align-items:center;">
          <div class="chip">#${idx+1}</div>
          <div><div style="font-weight:700">${r.name}</div>
               <div class="muted" style="font-size:12px">期待時給: 約${r.hourly}円/h・サンプル${r.samples_h}h</div></div>
        </div>
        <a class="btn" href="https://maps.google.com/?q=${r.lat},${r.lng}" target="_blank" rel="noopener">地図</a>
      </div>`;
    wrap.appendChild(a);
  });
}

// ルート描画
function renderPlan(data){
  const wrap = document.getElementById('plan-list'); wrap.innerHTML = "";
  if(!data.blocks || data.blocks.length===0){
    wrap.innerHTML = `<div class="muted">データが少ないため、十分な精度で提案できません。過去の実績入力（エリア選択付き）をお願いします。</div>`;
    return;
  }
  data.blocks.forEach(b => {
    const el = document.createElement('div');
    el.className = 'card'; el.style.padding = '10px';
    el.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;flex-wrap:wrap;">
        <div>
          <div style="font-weight:700">${b.time} — ${b.name}</div>
          <div class="muted" style="font-size:12px">期待時給: 約${b.expected_hourly}円/h ・ サンプル${b.samples_h}h</div>
        </div>
        <a class="btn" href="https://maps.google.com/?q=${b.lat},${b.lng}" target="_blank" rel="noopener">この地点を地図で開く</a>
      </div>`;
    wrap.appendChild(el);
  });
}

async function refreshRanking(){
  const now = new Date();
  const data = await fetchJSON(`/api/areas/stats/?dow=${now.getDay()===0?6:now.getDay()-1}&hour=${now.getHours()}`);
  renderRanking(data);
}
async function makePlan(){
  const start = document.getElementById('plan-start').value || nowHHMM();
  const hours = document.getElementById('plan-hours').value;
  const beta = document.getElementById('plan-beta').value;
  const data = await fetchJSON(`/api/areas/today_plan/?start=${encodeURIComponent(start)}&hours=${hours}&beta=${beta}`);
  renderPlan(data);
}

// 初期化
document.addEventListener('DOMContentLoaded', async () => {
  document.getElementById('plan-start').value = nowHHMM();
  try { await refreshRanking(); } catch(e){ console.error(e); }
  document.getElementById('btn-make-plan').addEventListener('click', makePlan);
});
</script>
{% endblock %}
