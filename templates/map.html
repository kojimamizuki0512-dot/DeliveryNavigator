{% extends 'base.html' %}
{% block title %}マップ | Delivery Navigator{% endblock %}
{% block extra_head %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <style>
    .map-wrap{background:linear-gradient(180deg,rgba(126,226,190,.08),transparent) ,var(--surface);
      border:1px solid var(--border);border-radius:20px;padding:14px;box-shadow: var(--shadow-2);}
    #mapFull{width:100%;height:72vh;border-radius:16px}
    .legend{display:flex;gap:10px;align-items:center;margin:6px 0 12px}
    .legend-item{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:6px 12px;
      font-size:12px;border:1px solid var(--border);background:var(--surface)}
    .dot{width:10px;height:10px;border-radius:999px}
    .low{background:#9ca3af}.mid{background:#c4852e}.high{background:#18a058}
  </style>
{% endblock %}
{% block content %}
<div class="map-wrap">
  <div class="legend">
    <span class="legend-item"><span class="dot low"></span>低</span>
    <span class="legend-item"><span class="dot mid"></span>中</span>
    <span class="legend-item"><span class="dot high"></span>高</span>
  </div>
  <div id="mapFull"></div>
</div>
{% endblock %}
{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
  const WARD_POS = DN_DATA.ward_pos || {};
  const levelColor = (w)=> (w>=1800 ? '#18a058' : (w>=1600 ? '#c4852e' : '#9ca3af'));
  const centerTokyo = [35.681236,139.767125];
  const map = L.map('mapFull').setView(centerTokyo, 12);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
    attribution:'&copy; OpenStreetMap & Carto',maxZoom:19
  }).addTo(map);

  const markers=[];
  (DN_DATA.areas || []).forEach(it=>{
    const name = it.area || 'エリア';
    const wage = Number(it.wage_per_h || 0);
    const center = Array.isArray(it.center)&&it.center.length===2 ? it.center : (WARD_POS[name]||null);
    if (!center) return;
    const color = levelColor(wage);
    const m = L.circleMarker(center,{ radius:10,color,fillColor:color,fillOpacity:.6,weight:2 }).addTo(map);
    m.bindPopup(`<strong>${name}</strong><br>${wage?`目安：¥${wage}/h`:'目安：—'}`);
    markers.push(m);
  });
  if (markers.length) map.fitBounds(L.featureGroup(markers).getBounds().pad(0.2));
</script>
{% endblock %}
