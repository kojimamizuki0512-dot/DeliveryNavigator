{% extends "base.html" %}
{% block title %}ダッシュボード | Delivery Navigator{% endblock %}
{% block content %}
<h1 style="margin:0 0 8px 0;">ダッシュボード</h1>
<p class="muted">今月の実績と直近30日のトレンドを表示します。</p>

<!-- KPI カード -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:16px 0;">
  <div class="card"><h3>今月 売上合計</h3><div id="kpi-earn" style="font-size:28px;font-weight:700">-</div></div>
  <div class="card"><h3>今月 件数</h3><div id="kpi-ord" style="font-size:28px;font-weight:700">-</div></div>
  <div class="card"><h3>今月 平均時給</h3><div id="kpi-hr" style="font-size:28px;font-weight:700">-</div></div>
  <div class="card"><h3>今日</h3><div id="kpi-today" class="muted">-</div></div>
</div>

<!-- チャート -->
<div class="card">
  <h3 style="margin-top:0">日別 売上（直近30日）</h3>
  <canvas id="chartDaily" height="140"></canvas>
</div>
<div class="card" style="margin-top:12px">
  <h3 style="margin-top:0">累積 売上（直近30日）</h3>
  <canvas id="chartCum" height="140"></canvas>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function(){
  const fmtYMD = d => {
    const y = d.getFullYear();
    const m = ('0'+(d.getMonth()+1)).slice(-2);
    const day = ('0'+d.getDate()).slice(-2);
    return `${y}-${m}-${day}`;
  };
  const yen = n => (Math.round(+n)).toLocaleString('ja-JP');

  const today = new Date();
  const start30 = new Date(); start30.setDate(today.getDate()-29);
  const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);

  // --- KPI（今月） ---
  fetch(`/api/deliveries/summary?start=${fmtYMD(monthStart)}&end=${fmtYMD(today)}`)
    .then(r=>r.json())
    .then(s=>{
      document.getElementById('kpi-earn').textContent = `${yen(s.total_earnings||0)} 円`;
      document.getElementById('kpi-ord').textContent = `${s.total_orders||0} 件`;
      const hr = s.hourly_rate ? `${yen(s.hourly_rate)} 円/h` : '-';
      document.getElementById('kpi-hr').textContent = hr;
    });

  // --- 今日 ---
  fetch(`/api/deliveries/summary?start=${fmtYMD(today)}&end=${fmtYMD(today)}`)
    .then(r=>r.json())
    .then(s=>{
      const txt = `売上 ${yen(s.total_earnings||0)} / 件数 ${s.total_orders||0}`;
      document.getElementById('kpi-today').textContent = txt;
    });

  // --- 30日分の明細（欠損日は0埋め） ---
  fetch(`/api/deliveries/?start=${fmtYMD(start30)}&end=${fmtYMD(today)}`)
    .then(r=>r.json())
    .then(data=>{
      const rows = Array.isArray(data) ? data : (data.results || []);
      const byDate = {};
      rows.forEach(r => { byDate[r.date] = (byDate[r.date]||0) + parseFloat(r.earnings||0); });

      const labels = [];
      const dailies = [];
      const cum = [];
      let run = 0;
      for(let d=new Date(start30); d<=today; d.setDate(d.getDate()+1)){
        const key = fmtYMD(d);
        const v = +(+byDate[key]||0).toFixed(0);
        labels.push(key);
        dailies.push(v);
        run += v;
        cum.push(run);
      }

      const ctx1 = document.getElementById('chartDaily').getContext('2d');
      const ctx2 = document.getElementById('chartCum').getContext('2d');

      new Chart(ctx1, {
        type: 'bar',
        data: { labels, datasets: [{ label: '売上(円)', data: dailies }] },
        options: { responsive: true, plugins:{ legend:{ display:false }}, scales:{ x:{ ticks:{ maxRotation:0, autoSkip:true }}, y:{ beginAtZero:true } } }
      });

      new Chart(ctx2, {
        type: 'line',
        data: { labels, datasets: [{ label: '累積(円)', data: cum, fill:false }] },
        options: { responsive: true, plugins:{ legend:{ display:false }}, scales:{ x:{ ticks:{ maxRotation:0, autoSkip:true }}, y:{ beginAtZero:true } } }
      });
    });
})();
</script>
{% endblock %}
