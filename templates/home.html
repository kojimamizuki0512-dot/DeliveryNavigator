{% extends "base.html" %}
{% load static %}
{% block title %}Delivery Navigator — いま稼げる地域{% endblock %}

{% block content %}
<h1 style="font-weight:800;margin:8px 0 16px;">いま稼げる地域</h1>

<div class="grid cols-2">
  <!-- 左：地図 -->
  <section class="card" style="padding:0; height:70vh; overflow:hidden;">
    <div id="map" style="width:100%; height:70vh;"></div>
  </section>

  <!-- 右：今すぐ3エリア + 補助 -->
  <section class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3 style="margin:0">今すぐの3エリア</h3>
      <div class="muted" id="now-hour">--:--</div>
    </div>
    <div id="top-cards" style="margin-top:8px"></div>

    <div class="muted" style="margin-top:16px;font-size:12px">
      提示は統計ベース（直近データ）。「直近◎」は過去7日で好調だったエリアです。
    </div>
  </section>
</div>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
 integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
 integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
let map, markersLayer, labelsLayer;

// グラデーション（低→高）
function colorFor(yen){
  // 0〜max をざっくり。p90などはAPI側で調整済み想定、ここは簡易。
  const v = Math.max(0, Math.min(1, (yen || 0) / 3000)); // 0〜3,000円/h を 0..1 に
  const r = Math.floor(255 * v);
  const g = Math.floor(200 * v);
  const b = Math.floor(255 * (1 - v));
  return `rgb(${r},${g},${b})`; // 青→赤寄り
}

// 数字ラベル（円/h）
function makeLabelHtml(yen){
  return `<div style="
    background: rgba(0,0,0,0.55);
    color:#fff; padding:2px 6px; border-radius:8px; font-size:12px; border:1px solid rgba(255,255,255,0.15);
  ">${Math.round(yen)}<span style="font-size:10px;margin-left:2px">円/h</span></div>`;
}

function setNowHour(){
  const d = new Date();
  document.getElementById('now-hour').textContent =
    `${String(d.getHours()).padStart(2,'0')}:00`;
}

async function loadStats(){
  setNowHour();
  const res = await fetch('/api/areas/stats?top=3', {credentials:'same-origin'});
  const js = await res.json();

  // 地図に反映（色＋数字）
  markersLayer.clearLayers();
  labelsLayer.clearLayers();
  (js.items||[]).forEach(it=>{
    if(it.lat==null || it.lng==null) return;
    const c = colorFor(it.hourly);
    const circle = L.circleMarker([it.lat, it.lng], {
      radius: 18, weight: 2, color: c, fillColor: c, fillOpacity: 0.35
    }).addTo(markersLayer).bindTooltip(`${it.name} / 約${Math.round(it.hourly)}円/h`);

    const divIcon = L.divIcon({html: makeLabelHtml(it.hourly), className: '', iconSize: [60,24]});
    L.marker([it.lat, it.lng], {icon: divIcon}).addTo(labelsLayer);
  });

  // 右ペイン：今すぐ3エリアカード
  const box = document.getElementById('top-cards');
  box.innerHTML = (js.top||[]).map(it => `
    <div class="card" style="margin:10px 0;padding:12px; display:flex; align-items:center; justify-content:space-between;">
      <div>
        <div style="font-weight:700">${it.name}
          ${it.recent_hot ? '<span class="chip" style="margin-left:6px;background:#3b5c1a;color:#c8f5a2;border-color:#527c2a">直近◎</span>' : ''}
        </div>
        <div class="muted" style="font-size:12px">約 ${Math.round(it.hourly)} 円 / h ・ サンプル ${it.hours} h</div>
      </div>
      ${it.lat!=null && it.lng!=null ? `<button class="btn" onclick="fly(${it.lat},${it.lng})">ズーム</button>` : ''}
    </div>
  `).join('');
}

function fly(lat,lng){
  map.flyTo([lat,lng], 15, {duration: 0.7});
}

(function boot(){
  map = L.map('map', {zoomControl:true}).setView([35.68,139.76], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  markersLayer = L.layerGroup().addTo(map);
  labelsLayer = L.layerGroup().addTo(map);

  loadStats();
  // 5分ごとに更新（任意）
  setInterval(loadStats, 5*60*1000);
})();
</script>
{% endblock %}
