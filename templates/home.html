{% extends 'base.html' %}
{% block title %}ホーム | Delivery Navigator{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <style>
    .quick-links { display: flex; gap: 8px; flex-wrap: wrap; margin: 8px 0 16px; }
    .quick-links a {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 8px 12px; border: 1px solid var(--border);
      border-radius: 999px; text-decoration: none; color: var(--text);
      background: var(--surface);
    }
    .home-grid { display: grid; gap: 16px; grid-template-columns: 1fr; align-items: start; }
    @media (min-width: 980px) { .home-grid { grid-template-columns: 1.2fr 0.8fr; } }
    .panel { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; }
    .panel h2 { margin: 0 0 8px; font-size: var(--fs-800); }
    #leafletMap { width: 100%; height: 520px; border-radius: var(--radius); }
    .legend { display: inline-flex; gap: 8px; align-items: center; margin: 8px 0 12px; }
    .legend-item { border-radius: 999px; padding: 6px 12px; font-size: 12px; border: 1px solid var(--border); }
    .legend-low  { background: repeating-linear-gradient(45deg, #e5e7eb, #e5e7eb 6px, #f8fafc 6px, #f8fafc 12px); color: #374151; }
    .legend-mid  { background: repeating-linear-gradient(45deg, #f6e9d4, #f6e9d4 6px, #fff3e0 6px, #fff3e0 12px); color: #8a5a18; }
    .legend-high { background: repeating-linear-gradient(45deg, #d8f3dc, #d8f3dc 6px, #c7f6e2 6px, #c7f6e2 12px); color: #065f46; }
    .route-list { list-style: none; padding: 0; margin: 8px 0 0; display: grid; gap: 10px; }
    .route-item { border: 1px dashed var(--border); border-radius: 12px; padding: 10px 12px;
      display: grid; grid-template-columns: 92px 1fr max-content; gap: 8px; align-items: center;
      transition: background .15s ease, border-color .15s ease; }
    .route-item.active { border-color: var(--brand-2); background: color-mix(in oklab, var(--surface) 85%, var(--brand-2)); }
    .route-time { font-weight: 700; }
    .route-area { font-size: 14px; }
    .route-wage { font-weight: 700; }
    .muted { color: var(--muted); }
    .sub { font-size: 12px; color: var(--muted); }
  </style>
{% endblock %}

{% block content %}
<nav class="quick-links" aria-label="ショートカット">
  <a href="/map">マップ</a>
  <a href="/upload/">データ読み込み</a>
  <a href="/records">記録</a>
  <a href="/dashboard">ダッシュボード</a>
</nav>

<section class="home-grid">
  <div class="panel">
    <h2>いま稼げるエリア</h2>
    <p class="muted">色の強さで目安を表示します。点をタップすると詳しく出ます。</p>
    <div class="legend" aria-label="凡例">
      <span class="legend-item legend-low">低</span>
      <span class="legend-item legend-mid">中</span>
      <span class="legend-item legend-high">高</span>
    </div>
    <div id="leafletMap" data-endpoint="/api/areas/stats?mode=base"></div>
  </div>

  <div class="panel">
    <h2>今日のおすすめルート（30分刻み）</h2>
    <p class="muted">はじめの2〜3時間の目安。状況で変わるので、時々更新してください。</p>
    <ul id="routeList" class="route-list"
        data-endpoint="/api/areas/today_plan?hours=3&step=30&mode=base">
      <li class="sub">読み込み中…</li>
    </ul>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
  const WARD_POS = {
    '千代田区':[35.6938,139.7530],'中央区':[35.6704,139.7720],'港区':[35.6581,139.7516],
    '新宿区':[35.6938,139.7034],'文京区':[35.7081,139.7528],'台東区':[35.7126,139.7800],
    '墨田区':[35.7107,139.8016],'江東区':[35.6733,139.8174],'品川区':[35.6093,139.7300],
    '目黒区':[35.6417,139.6986],'大田区':[35.5613,139.7160],'世田谷区':[35.6467,139.6532],
    '渋谷区':[35.6618,139.7041],'中野区':[35.7074,139.6659],'杉並区':[35.6993,139.6364],
    '豊島区':[35.7261,139.7289],'北区':[35.7528,139.7330],'荒川区':[35.7364,139.7830],
    '板橋区':[35.7511,139.7100],'練馬区':[35.7356,139.6517],'足立区':[35.7754,139.8045],
    '葛飾区':[35.7436,139.8476],'江戸川区':[35.7060,139.8686]
  };
  const routeColor = () => getComputedStyle(document.documentElement).getPropertyValue('--brand-2').trim() || '#00754A';
  const levelColor = (w)=> (w>=1800 ? '#18a058' : (w>=1600 ? '#c4852e' : '#9ca3af'));

  let dnMap, heatMarkers=[], routeLine=null, routeStops=[];

  (function initMap(){
    const el = document.getElementById('leafletMap');
    if (!el) return;
    const centerTokyo = [35.681236,139.767125];
    dnMap = L.map(el, { zoomControl:true }).setView(centerTokyo, 12);

    const light = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{ attribution:'&copy; OpenStreetMap & Carto', maxZoom:19 });
    const dark  = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{  attribution:'&copy; OpenStreetMap & Carto', maxZoom:19 });

    function applyBase() {
      const isDark = document.documentElement.getAttribute('data-theme') === 'espresso';
      if (dnMap.hasLayer(light)) dnMap.removeLayer(light);
      if (dnMap.hasLayer(dark))  dnMap.removeLayer(dark);
      (isDark ? dark : light).addTo(dnMap);
      if (routeLine) routeLine.setStyle({ color: routeColor() });
      routeStops.forEach(m => m.setStyle && m.setStyle({ color: routeColor(), fillColor: routeColor() }));
    }
    applyBase();
    new MutationObserver(applyBase).observe(document.documentElement,{ attributes:true, attributeFilter:['data-theme'] });

    (async function loadHeat(){
      try {
        const r = await fetch(el.dataset.endpoint,{ credentials:'same-origin' });
        const data = await r.json();
        let items=[];
        if (Array.isArray(data?.items)) items=data.items;
        else if (Array.isArray(data?.top)) items=data.top;
        else if (Array.isArray(data)) items=data;

        const markers=[];
        items.forEach(it=>{
          const name=it.area||it.name||'エリア';
          const wage=Number(it.wage_per_h||it.score||0);
          const center=Array.isArray(it.center)&&it.center.length===2 ? it.center : (WARD_POS[name]||null);
          if (!center) return;
          const color=levelColor(wage);
          const m=L.circleMarker(center,{ radius:10,color,fillColor:color,fillOpacity:.6,weight:2 }).addTo(dnMap);
          m.bindPopup(`<strong>${name}</strong><br>${wage?`目安：¥${wage}/h`:'目安：—'}${it.note?`<br><span style="color:var(--muted)">${it.note}</span>`:''}`);
          markers.push(m);
        });
        heatMarkers=markers;
        if (markers.length) dnMap.fitBounds(L.featureGroup(markers).getBounds().pad(0.2));
      } catch(e){ console.warn(e); }
    })();
  })();

  (async function loadRoute(){
    const list=document.getElementById('routeList');
    if(!list) return;

    try{
      const r=await fetch(list.dataset.endpoint,{ credentials:'same-origin' });
      const data=await r.json();
      let items=[];
      if (Array.isArray(data?.items)) items=data.items;
      else if (Array.isArray(data?.plan)) items=data.plan;
      else if (Array.isArray(data)) items=data;

      const now=new Date();
      const pad=n=>String(n).padStart(2,'0');
      const addMin=(d,m)=>new Date(d.getTime()+m*60000);
      if(!items.length){
        items=[
          {area:'中央区',to:'勝どき',wage_per_h:1820,note:'短距離多め'},
          {area:'港区',to:'六本木',wage_per_h:1760,note:'坂注意'},
          {area:'江東区',to:'豊洲',wage_per_h:1690,note:'買い物帰りピーク'}
        ];
      }
      items=items.map((it,i)=>{ if(!it.time){const t=addMin(now,i*30); it.time=`${pad(t.getHours())}:${pad(t.getMinutes())}`;} return it; });

      list.innerHTML=items.map((it,i)=>`
        <li class="route-item" data-idx="${i}">
          <div class="route-time">${it.time}</div>
          <div class="route-area">
            <strong>${it.area||'—'}</strong>${it.to?` <span class="muted">→ ${it.to}</span>`:''}
            ${it.note?`<div class="sub">${it.note}</div>`:''}
          </div>
          <div class="route-wage">${it.wage_per_h?('¥'+it.wage_per_h):'—'}/h</div>
        </li>`).join('');

      function coordOf(it){
        if (Array.isArray(it.center)&&it.center.length===2) return it.center;
        if (it.lat!=null && it.lng!=null) return [Number(it.lat),Number(it.lng)];
        const name=it.area||it.name||''; return WARD_POS[name]||null;
      }
      const coords=items.map(coordOf).filter(Boolean);
      if (routeLine){ dnMap.removeLayer(routeLine); routeLine=null; }
      routeStops.forEach(m=>dnMap.removeLayer(m)); routeStops=[];

      if (coords.length>=2){
        routeLine=L.polyline(coords,{ color:routeColor(), weight:5, opacity:.9 }).addTo(dnMap);
        coords.forEach((pt,i)=>{
          const m=L.circleMarker(pt,{ radius:7, color:routeColor(), fillColor:routeColor(), fillOpacity:.9, weight:2 })
            .addTo(dnMap)
            .bindPopup(`<div><strong>${items[i].time}</strong>　${items[i].area||'—'}${items[i].to?` → ${items[i].to}`:''}<br>${items[i].wage_per_h?`目安：¥${items[i].wage_per_h}/h`:'目安：—'}</div>`);
          routeStops.push(m);
        });
        dnMap.fitBounds(routeLine.getBounds().pad(0.25));
      }

      list.addEventListener('click',(e)=>{
        const li=e.target.closest('.route-item'); if(!li) return;
        const i=Number(li.dataset.idx); const pt=coords[i]; if(!pt) return;
        list.querySelectorAll('.route-item').forEach(x=>x.classList.remove('active'));
        li.classList.add('active');
        dnMap.setView(pt, Math.max(dnMap.getZoom(), 13), { animate:true });
        if (routeStops[i]) routeStops[i].openPopup();
      });

    }catch(e){
      console.warn(e);
      list.innerHTML='<li class="sub">読み込みに失敗しました</li>';
    }
  })();
</script>
{% endblock %}
