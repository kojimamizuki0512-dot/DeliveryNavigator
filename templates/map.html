{% extends 'base.html' %}
{% block title %}マップ | Delivery Navigator{% endblock %}
{% block extra_head %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <style>
    .map-wrap{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px}
    #mapFull{width:100%;height:72vh;border-radius:var(--radius)}
    .legend{display:inline-flex;gap:8px;align-items:center;margin:8px 0 12px}
    .legend-item{border-radius:999px;padding:6px 12px;font-size:12px;border:1px solid var(--border)}
    .legend-low{background:repeating-linear-gradient(45deg,#e5e7eb,#e5e7eb 6px,#f8fafc 6px,#f8fafc 12px);color:#374151}
    .legend-mid{background:repeating-linear-gradient(45deg,#f6e9d4,#f6e9d4 6px,#fff3e0 6px,#fff3e0 12px);color:#8a5a18}
    .legend-high{background:repeating-linear-gradient(45deg,#d8f3dc,#d8f3dc 6px,#c7f6e2 6px,#c7f6e2 12px);color:#065f46}
  </style>
{% endblock %}
{% block content %}
<div class="map-wrap">
  <div class="legend" aria-label="凡例">
    <span class="legend-item legend-low">低</span>
    <span class="legend-item legend-mid">中</span>
    <span class="legend-item legend-high">高</span>
  </div>
  <div id="mapFull"></div>
</div>
{% endblock %}
{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
  const WARD_POS = DN_DATA.ward_pos || {};
  const levelColor = (w)=> (w>=1800 ? '#18a058' : (w>=1600 ? '#c4852e' : '#9ca3af'));
  const centerTokyo = [35.681236,139.767125];
  const map = L.map('mapFull').setView(centerTokyo, 12);
  const light = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{ attribution:'&copy; OpenStreetMap & Carto', maxZoom:19 }).addTo(map);
  const markers=[];
  (DN_DATA.areas || []).forEach(it=>{
    const name = it.area || 'エリア';
    const wage = Number(it.wage_per_h || 0);
    const center = Array.isArray(it.center)&&it.center.length===2 ? it.center : (WARD_POS[name]||null);
    if (!center) return;
    const color = levelColor(wage);
    const m = L.circleMarker(center,{ radius:10,color,fillColor:color,fillOpacity:.6,weight:2 }).addTo(map);
    m.bindPopup(`<strong>${name}</strong><br>${wage?`目安：¥${wage}/h`:'目安：—'}`);
    markers.push(m);
  });
  if (markers.length) map.fitBounds(L.featureGroup(markers).getBounds().pad(0.2));
</script>
{% endblock %}
