{% extends 'base.html' %}
{% block title %}ホーム | Delivery Navigator{% endblock %}
{% block extra_head %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <style>
    .home-grid{display:grid;gap:18px;grid-template-columns:1fr}
    @media (min-width:980px){.home-grid{grid-template-columns:1.25fr .75fr}}
    .panel{background:linear-gradient(180deg,rgba(126,226,190,.08),transparent),var(--surface);
      border:1px solid var(--border);border-radius:20px;padding:16px;box-shadow:var(--shadow-2)}
    .panel h2{margin:0 0 10px;font-size:var(--fs-800);letter-spacing:.2px}
    .legend{display:flex;gap:10px;align-items:center;margin:6px 0 12px}
    .legend-item{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:6px 12px;font-size:12px;border:1px solid var(--border);background:var(--surface)}
    .dot{width:10px;height:10px;border-radius:999px}
    .low{background:#9ca3af}.mid{background:#c4852e}.high{background:#18a058}
    #leafletMap{width:100%;height:560px;border-radius:16px}
    .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .select{border:1px solid var(--border);border-radius:10px;background:var(--surface);padding:8px 10px}
    .route-list{display:grid;gap:12px;margin-top:10px;list-style:none;padding:0}
    .route-card{border:1px solid var(--border);border-radius:16px;background:var(--surface);padding:12px;display:grid;grid-template-columns:92px 1fr auto;gap:10px;align-items:center}
    .route-card.active{outline:2px solid var(--brand-2);background:color-mix(in oklab,var(--surface) 85%,var(--brand-2))}
    .route-time{font-weight:800}
    .route-area{font-weight:600}
    .route-wage{font-weight:800}
  </style>
{% endblock %}

{% block content %}
<section class="home-grid">
  <div class="panel">
    <h2>いま稼げるエリア</h2>
    <div class="toolbar">
      <label class="small muted">ジャンプ：</label>
      <select id="jumpSelect" class="select"></select>
      <button id="btnJump" class="btn btn-outline btn-sm">移動</button>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button id="btnReload" class="btn btn-outline btn-sm">更新</button>
        <button id="btnLocate" class="btn btn-outline btn-sm">現在地</button>
      </div>
    </div>
    <div class="legend">
      <span class="legend-item"><span class="dot low"></span>低</span>
      <span class="legend-item"><span class="dot mid"></span>中</span>
      <span class="legend-item"><span class="dot high"></span>高</span>
    </div>
    <div id="leafletMap"></div>
    <div id="mapInfo" class="small muted" style="margin-top:6px"></div>
  </div>

  <div class="panel">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h2>今日のおすすめルート</h2>
      <div style="display:flex;gap:8px">
        <button id="btnGPX" class="btn btn-outline btn-sm">GPX保存</button>
        <button id="btnCopy" class="btn btn-outline btn-sm">一覧コピー</button>
      </div>
    </div>
    <p class="small muted">30分刻み。行を押すと地図へフォーカスします。</p>
    <ul id="routeList" class="route-list"><li class="small muted">読み込み中…</li></ul>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
  const WARD_POS = DN_DATA.ward_pos || {};
  const routeColor = () => getComputedStyle(document.documentElement).getPropertyValue('--brand-2').trim() || '#00a36c';
  const levelColor = (w)=> (w>=1800 ? '#18a058' : (w>=1600 ? '#c4852e' : '#9ca3af'));

  let map, heatMarkers=[], routeLine=null, routeStops=[];
  (function initMap(){
    const el = document.getElementById('leafletMap');
    const centerTokyo = [35.681236,139.767125];
    map = L.map(el, { zoomControl:true }).setView(centerTokyo, 12);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
      attribution:'&copy; OpenStreetMap & Carto',maxZoom:19
    }).addTo(map);

    drawHeat(DN_DATA.areas || []);
    fitToHeat();

    const sel = document.getElementById('jumpSelect');
    Object.keys(WARD_POS).forEach(w=>{const o=document.createElement('option');o.value=w;o.textContent=w;sel.appendChild(o);});
    document.getElementById('btnJump').addEventListener('click', ()=>{const w=sel.value;const pos=WARD_POS[w];if(pos) map.setView(pos,13,{animate:true});});
    document.getElementById('btnLocate').addEventListener('click', ()=>{
      if(!navigator.geolocation) return alert('位置情報が使えません');
      navigator.geolocation.getCurrentPosition(p=>{
        const pt=[p.coords.latitude,p.coords.longitude]; map.setView(pt,15,{animate:true});
        L.circleMarker(pt,{radius:8,color:'#22c55e',fillColor:'#22c55e',fillOpacity:.9,weight:2}).addTo(map).bindPopup('現在地');
      }, ()=>alert('現在地を取得できませんでした'));
    });
    document.getElementById('btnReload').addEventListener('click', ()=>{
      const next=(DN_DATA.areas||[]).map(a=>({...a,wage_per_h:Math.round((a.wage_per_h||1500)*(0.95+Math.random()*0.1))}));
      drawHeat(next,true); fitToHeat();
    });

    loadRoute();
  })();

  function drawHeat(items, clear=false){
    if (clear||heatMarkers.length){ heatMarkers.forEach(m=>map.removeLayer(m)); heatMarkers=[]; }
    const info=document.getElementById('mapInfo'); const markers=[];
    items.forEach(it=>{
      const name=it.area||'エリア'; const wage=Number(it.wage_per_h||0);
      const center=Array.isArray(it.center)&&it.center.length===2 ? it.center : (WARD_POS[name]||null); if(!center) return;
      const color=levelColor(wage);
      const m=L.circleMarker(center,{radius:10,color,fillColor:color,fillOpacity:.6,weight:2}).addTo(map);
      m.bindPopup(`<strong>${name}</strong><br>${wage?`目安：¥${wage}/h`:'目安：—'}`);
      markers.push(m);
    });
    heatMarkers=markers; info.textContent=`表示件数：${markers.length}`;
  }
  function fitToHeat(){ if(!heatMarkers.length) return; map.fitBounds(L.featureGroup(heatMarkers).getBounds().pad(0.2)); }

  function loadRoute(){
    const list=document.getElementById('routeList');
    const items = Array.isArray(DN_DATA.plan)? DN_DATA.plan : [];
    list.innerHTML = items.map((it,i)=>`
      <li class="route-card" data-idx="${i}">
        <div class="route-time">${it.time}</div>
        <div class="route-area">${it.area||'—'}${it.to?` <span class="muted">→ ${it.to}</span>`:''} ${it.note?`<div class="small muted">${it.note}</div>`:''}</div>
        <div class="route-wage">${it.wage_per_h?('¥'+it.wage_per_h):'—'}/h</div>
      </li>`).join('');

    const coords = items.map(it=>{
      if (Array.isArray(it.center)&&it.center.length===2) return it.center;
      if (it.lat!=null && it.lng!=null) return [Number(it.lat),Number(it.lng)];
      return WARD_POS[it.area||'']||null;
    }).filter(Boolean);

    if (routeLine){ map.removeLayer(routeLine); routeLine=null; }
    routeStops.forEach(m=>map.removeLayer(m)); routeStops=[];
    if (coords.length>=2){
      routeLine=L.polyline(coords,{ color:routeColor(), weight:5, opacity:.9 }).addTo(map);
      coords.forEach((pt,i)=>{
        const m=L.circleMarker(pt,{ radius:7, color:routeColor(), fillColor:routeColor(), fillOpacity:.9, weight:2 })
          .addTo(map)
          .bindPopup(`<div><strong>${items[i].time}</strong>　${items[i].area||'—'}${items[i].to?` → ${items[i].to}`:''}<br>${items[i].wage_per_h?`目安：¥${items[i].wage_per_h}/h`:'目安：—'}</div>`);
        routeStops.push(m);
      });
      map.fitBounds(routeLine.getBounds().pad(0.25));
    }

    list.addEventListener('click',(e)=>{
      const li=e.target.closest('.route-card'); if(!li) return;
      const i=Number(li.dataset.idx); const pt=coords[i]; if(!pt) return;
      list.querySelectorAll('.route-card').forEach(x=>x.classList.remove('active'));
      li.classList.add('active');
      map.setView(pt, Math.max(map.getZoom(), 13), { animate:true });
      if (routeStops[i]) routeStops[i].openPopup();
    });

    document.getElementById('btnGPX').addEventListener('click', ()=>{
      if (!coords.length) return alert('ルートがありません');
      const head=`<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1" creator="DN" xmlns="http://www.topografix.com/GPX/1/1"><trk><name>DN Route</name><trkseg>`;
      const body=coords.map(c=>`<trkpt lat="${c[0]}" lon="${c[1]}"></trkpt>`).join('');
      const foot=`</trkseg></trk></gpx>`;
      const blob=new Blob([head+body+foot],{type:'application/gpx+xml'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='dn_route.gpx'; a.click(); URL.revokeObjectURL(a.href);
    });
    document.getElementById('btnCopy').addEventListener('click', ()=>{
      const text = items.map(it=>`${it.time}  ${it.area||'—'}${it.to?` → ${it.to}`:''}  ${it.wage_per_h?('¥'+it.wage_per_h+'/h'):''}  ${it.note||''}`).join('\n');
      navigator.clipboard.writeText(text).then(()=> alert('コピーしました'));
    });
  }
</script>
{% endblock %}
